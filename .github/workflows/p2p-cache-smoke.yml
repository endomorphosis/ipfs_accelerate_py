name: P2P Cache Smoke Test

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: '3.12'
  CACHE_DIR: ${{ github.workspace }}/.cache/github-api
  IPFS_ACCELERATE_CACHE_DIR: ${{ github.workspace }}/.cache/github-api

jobs:
  p2p-cache-smoke:
    name: P2P cache local two-node smoke
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare cache dir
        shell: bash
        run: |
          mkdir -p "${CACHE_DIR}"

      - name: Restore GitHub API cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CACHE_DIR }}
          key: github-api-cache-${{ runner.os }}-${{ github.repository }}-p2p-smoke
          restore-keys: |
            github-api-cache-${{ runner.os }}-${{ github.repository }}-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install package
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install P2P dependencies
        shell: bash
        run: |
          # libp2p is optional at runtime, but required for this smoke test.
          pip install \
            "libp2p @ git+https://github.com/libp2p/py-libp2p@main" \
            cryptography

      - name: Run local two-node smoke test (synthetic)
        env:
          CACHE_P2P_SHARED_SECRET: ci-local-secret
        shell: bash
        run: |
          python tools/github_p2p_cache_smoke.py \
            --read \
            --local-two-node \
            --synthetic \
            --target octocat/Hello-World \
            --wait-seconds 30 \
            --poll-interval 0.5

      - name: Save GitHub API cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.CACHE_DIR }}
          key: github-api-cache-${{ runner.os }}-${{ github.repository }}-p2p-smoke

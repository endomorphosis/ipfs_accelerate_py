name: AMD64 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      build_gpu_images:
        description: 'Build GPU-accelerated images'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  DOCKER_BUILDKIT: 1

jobs:
  # AMD64 native testing
  test-amd64-native:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: System Information
      run: |
        echo "=== System Information ==="
        uname -a
        lscpu | grep -E "Architecture|CPU|Model name|Thread|Core" || true
        free -h
        df -h /
        python --version
        docker --version
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # Install base requirements
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
        # Install package with testing dependencies
        pip install -e ".[minimal,testing]"
        
    - name: Run basic tests
      run: |
        # Test basic imports
        python -c "import ipfs_accelerate_py; print('‚úÖ Package import successful')"
        python -c "import platform; print(f'‚úÖ Platform: {platform.platform()}')"
        
        # Test CLI
        python -m ipfs_accelerate_py.cli_entry --help
        
    - name: Run unit tests
      run: |
        if [ -d "tests" ]; then
          python -m pytest tests/ -v --timeout=300 --tb=short
        else
          echo "‚ÑπÔ∏è No tests directory found"
        fi
        
    - name: Test IPFS functionality
      run: |
        python -c "
        try:
            import ipfshttpclient
            print('‚úÖ IPFS client available')
        except ImportError as e:
            print(f'‚ö†Ô∏è IPFS client not available: {e}')
        except Exception as e:
            print(f'‚ÑπÔ∏è IPFS connection test (expected to fail in CI): {e}')
        "

  # AMD64 Docker testing
  test-amd64-docker:
    runs-on: ubuntu-latest
    needs: test-amd64-native
    # Only run Docker builds on schedule or manual trigger to save resources
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event.inputs.build_gpu_images == 'true'
    
    strategy:
      matrix:
        docker-target: [minimal]  # Only build minimal by default to save space
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Free up disk space
      run: |
        echo "=== Before cleanup ==="
        df -h /
        
        # Remove unnecessary software
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo docker system prune -af --volumes
        
        echo "=== After cleanup ==="
        df -h /
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        target: ${{ matrix.docker-target }}
        tags: ipfs-accelerate-py:test-${{ matrix.docker-target }}-amd64
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        TARGET="${{ matrix.docker-target }}"
        IMAGE_TAG="ipfs-accelerate-py:test-$TARGET-amd64"
        
        echo "üß™ Testing Docker image: $IMAGE_TAG"
        
        # Test basic functionality
        docker run --rm --platform linux/amd64 $IMAGE_TAG python -c "import ipfs_accelerate_py; print('‚úÖ Docker import test passed')"
        
        # Test CLI
        docker run --rm --platform linux/amd64 $IMAGE_TAG python -m ipfs_accelerate_py.cli_entry --help

  # Multi-architecture build testing
  test-multiarch-build:
    runs-on: ubuntu-latest
    needs: test-amd64-docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU for cross-platform builds
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build multi-architecture images
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        target: production
        tags: |
          ipfs-accelerate-py:multiarch-test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Don't push, just build to test compatibility

  # GPU testing (if requested)
  test-gpu-support:
    runs-on: ubuntu-latest
    needs: test-amd64-docker
    if: github.event.inputs.build_gpu_images == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build GPU-enabled image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        target: hardware-accelerated
        tags: ipfs-accelerate-py:gpu-test
        load: true
        
    - name: Test GPU image (without actual GPU)
      run: |
        # Test that the GPU image builds and basic functionality works
        docker run --rm ipfs-accelerate-py:gpu-test python -c "
        import ipfs_accelerate_py
        print('‚úÖ GPU image import successful')
        
        # Test torch availability (common GPU framework)
        try:
            import torch
            print(f'‚úÖ PyTorch available: {torch.__version__}')
            print(f'CUDA available: {torch.cuda.is_available()}')
        except ImportError:
            print('‚ÑπÔ∏è PyTorch not installed in this image')
        "

  # Docker Compose testing
  test-docker-compose:
    runs-on: ubuntu-latest
    needs: test-amd64-docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create required directories
      run: |
        mkdir -p data logs config models benchmarks test-results coverage-reports benchmark-results
        
    - name: Test Docker Compose
      run: |
        # Validate compose file
        docker compose config
        
        # Build and test main service
        docker compose build ipfs-accelerate-py
        docker compose up -d ipfs-accelerate-py
        
        # Wait for service to start
        sleep 10
        
        # Test if service is running
        if docker compose ps | grep -q "ipfs-accelerate-py.*Up"; then
          echo "‚úÖ Main service started successfully"
          
          # Test health endpoint if available
          curl -f http://localhost:8000/health || echo "‚ÑπÔ∏è No health endpoint available"
        else
          echo "‚ö†Ô∏è Service status check"
          docker compose logs ipfs-accelerate-py
        fi
        
        # Cleanup
        docker compose down --volumes

  # Integration testing
  test-integration:
    runs-on: ubuntu-latest
    needs: [test-amd64-native, test-amd64-docker]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies with full feature set
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all,testing]"
        
    - name: Run comprehensive integration tests
      run: |
        # Test all CLI commands
        python -m ipfs_accelerate_py.cli_entry --help
        
        # Test different subcommands if available
        python -m ipfs_accelerate_py.cli_entry --version || echo "No version command"
        
        # Test import of all major modules
        python -c "
        import ipfs_accelerate_py
        print('‚úÖ Main package imported')
        
        # Test submodule imports
        try:
            from ipfs_accelerate_py import cli_entry
            print('‚úÖ CLI module imported')
        except ImportError as e:
            print(f'‚ö†Ô∏è CLI import issue: {e}')
        
        print('‚úÖ Integration tests completed')
        "

  # Performance baseline
  performance-baseline:
    runs-on: ubuntu-latest
    needs: test-integration
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install performance testing dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all,testing]"
        pip install memory-profiler psutil
        
    - name: Run performance baseline tests
      run: |
        # Basic performance tests
        python -c "
        import time
        import psutil
        import ipfs_accelerate_py
        
        print('=== Performance Baseline ===')
        
        # Measure import time
        start_time = time.time()
        import ipfs_accelerate_py
        import_time = time.time() - start_time
        print(f'Import time: {import_time:.3f}s')
        
        # Memory usage
        process = psutil.Process()
        memory_mb = process.memory_info().rss / 1024 / 1024
        print(f'Memory usage: {memory_mb:.1f} MB')
        
        # CPU info
        cpu_count = psutil.cpu_count()
        print(f'CPU cores available: {cpu_count}')
        
        print('‚úÖ Performance baseline completed')
        "
        
    - name: Save performance metrics
      run: |
        echo "Performance metrics saved for commit ${{ github.sha }}" > performance-baseline.txt
        echo "Timestamp: $(date)" >> performance-baseline.txt
        
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-baseline-amd64
        path: performance-baseline.txt
        retention-days: 30

  # Final summary
  amd64-summary:
    runs-on: ubuntu-latest
    needs: [test-amd64-native, test-amd64-docker, test-docker-compose, test-integration, performance-baseline]
    if: always()
    
    steps:
    - name: Generate AMD64 Test Summary
      run: |
        echo "# üéØ AMD64 CI/CD Pipeline Summary" > amd64-summary.md
        echo "" >> amd64-summary.md
        echo "## üìã Test Results Overview" >> amd64-summary.md
        echo "- **Repository:** ${{ github.repository }}" >> amd64-summary.md
        echo "- **Commit SHA:** ${{ github.sha }}" >> amd64-summary.md  
        echo "- **Branch:** ${{ github.ref_name }}" >> amd64-summary.md
        echo "- **Platform:** AMD64 (x86_64)" >> amd64-summary.md
        echo "- **Workflow:** ${{ github.workflow }}" >> amd64-summary.md
        echo "" >> amd64-summary.md
        echo "## ‚úÖ Job Results" >> amd64-summary.md
        echo "- Native Testing: ${{ needs.test-amd64-native.result }}" >> amd64-summary.md
        echo "- Docker Testing: ${{ needs.test-amd64-docker.result }}" >> amd64-summary.md
        echo "- Docker Compose: ${{ needs.test-docker-compose.result }}" >> amd64-summary.md
        echo "- Integration Tests: ${{ needs.test-integration.result }}" >> amd64-summary.md
        echo "- Performance Baseline: ${{ needs.performance-baseline.result }}" >> amd64-summary.md
        echo "" >> amd64-summary.md
        echo "Generated at: $(date)" >> amd64-summary.md
        
        cat amd64-summary.md
        
        # Check if critical tests passed (allow Docker tests to be skipped)
        DOCKER_RESULT="${{ needs.test-amd64-docker.result }}"
        if [[ "${{ needs.test-amd64-native.result }}" == "success" ]] && [[ "$DOCKER_RESULT" == "success" || "$DOCKER_RESULT" == "skipped" ]]; then
          echo "üéâ AMD64 platform tests successful!"
          exit 0
        else
          echo "‚ùå Some critical AMD64 tests failed"
          exit 1
        fi
        
    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: amd64-test-summary
        path: amd64-summary.md
        retention-days: 30
name: Convert Issues to Draft PRs with Copilot

on:
  issues:
    types: [opened, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to convert to draft PR'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: '3.11'
  # GitHub CLI P2P caching configuration
  CACHE_ENABLE_P2P: 'true'
  CACHE_LISTEN_PORT: '9100'
  CACHE_DEFAULT_TTL: '300'
  CACHE_DIR: '/tmp/github_cli_cache'

jobs:
  create-draft-pr-with-copilot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug issue information
        run: |
          echo "## ðŸ” Issue to Draft PR Conversion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Event Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Event Name**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Number**: ${{ github.event.issue.number || github.event.inputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Title**: ${{ github.event.issue.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Author**: ${{ github.event.issue.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests
          # Install cache dependencies
          pip install cryptography multiformats-cid
          # Try to install libp2p (optional for P2P sharing)
          pip install libp2p-stubs || true
      
      - name: Get issue details
        id: get_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the issue number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          echo "Processing issue #$ISSUE_NUMBER"
          
          # Get issue details using cached gh API
          ISSUE_DATA=$(python tools/gh_api_cached.py "repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
          
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | python -c "import sys, json; print(json.load(sys.stdin)['title'])")
          ISSUE_AUTHOR=$(echo "$ISSUE_DATA" | python -c "import sys, json; print(json.load(sys.stdin)['author']['login'])")
          ISSUE_BODY=$(echo "$ISSUE_DATA" | python -c "import sys, json; print(json.load(sys.stdin).get('body', ''))")
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          
          # Save issue body to file for later use
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          
          # Check if this is an auto-generated issue from auto-healing system
          if echo "$ISSUE_TITLE" | grep -qE "^(Fix|Auto-heal):|workflow failure"; then
            if echo "$ISSUE_BODY" | grep -qE "Auto-generated|auto-healing|automated workflow"; then
              echo "âš ï¸  This is an auto-generated issue from the auto-healing system"
              echo "âš ï¸  Skipping to avoid duplicate PRs (auto-healing creates its own PRs)"
              echo "is_auto_generated=true" >> $GITHUB_OUTPUT
              
              echo "## â­ï¸ Skipping Auto-Generated Issue" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This issue was auto-generated by the auto-healing system." >> $GITHUB_STEP_SUMMARY
              echo "The auto-healing system creates its own PRs, so we skip this to avoid duplicates." >> $GITHUB_STEP_SUMMARY
              echo "- **Issue**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          fi
          
          echo "is_auto_generated=false" >> $GITHUB_OUTPUT
          
          echo "## Issue Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue Number**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: $ISSUE_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @$ISSUE_AUTHOR" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for existing draft PR
        id: check_existing
        if: steps.get_issue.outputs.is_auto_generated != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          
          # Check if there's already a PR for this issue
          echo "Searching for existing PRs for issue #$ISSUE_NUMBER"
          # Use cached API call for PR search
          EXISTING_PRS=$(python tools/gh_api_cached.py "search/issues?q=Fixes+%23$ISSUE_NUMBER+repo:${{ github.repository }}+is:pr" --jq '.total_count' 2>&1 || echo "0")
          
          echo "Found $EXISTING_PRS existing PRs"
          
          if [ "$EXISTING_PRS" -gt 0 ]; then
            echo "âš ï¸  Issue #$ISSUE_NUMBER already has $EXISTING_PRS PR(s) - skipping duplicate"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            
            echo "## â­ï¸ Skipping Duplicate PR Creation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This issue already has existing PR(s)." >> $GITHUB_STEP_SUMMARY
            echo "- **Issue**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
            echo "- **Existing PRs**: $EXISTING_PRS" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "should_skip=false" >> $GITHUB_OUTPUT
      
      - name: Generate branch name and PR details
        id: generate_details
        if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
        env:
          ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get_issue.outputs.issue_title }}
        run: |
          # Create a clean branch name from issue title
          BRANCH_NAME=$(echo "issue-${ISSUE_NUMBER}/$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-50 | sed 's/-$//')")
          
          # Generate PR title
          PR_TITLE="Fix: $ISSUE_TITLE"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          
          echo "## Generated Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Title**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
      
      - name: Create draft PR branch and commit
        id: create_branch
        if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          BRANCH_NAME="${{ steps.generate_details.outputs.branch_name }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Create and checkout new branch
          git checkout -b "$BRANCH_NAME"
          
          # Create README for the PR
          cat > ISSUE_${ISSUE_NUMBER}_README.md << 'README_EOF'
          # Automated Issue Resolution
          
          This branch was created automatically to address issue #${{ steps.get_issue.outputs.issue_number }}.
          
          ## Issue Details
          
          **Title**: ${{ steps.get_issue.outputs.issue_title }}
          **Author**: @${{ steps.get_issue.outputs.issue_author }}
          **Link**: https://github.com/${{ github.repository }}/issues/${{ steps.get_issue.outputs.issue_number }}
          
          ## Description
          
          README_EOF
          
          # Add issue body
          cat /tmp/issue_body.txt >> ISSUE_${ISSUE_NUMBER}_README.md
          
          cat >> ISSUE_${ISSUE_NUMBER}_README.md << 'README_EOF'
          
          ## Next Steps
          
          GitHub Copilot will automatically analyze this issue and implement the necessary changes.
          
          @copilot will be mentioned in the PR to trigger the automated implementation.
          
          ---
          
          ðŸ¤– *This file was auto-generated by the Issue-to-Draft-PR workflow*
          README_EOF
          
          git add ISSUE_${ISSUE_NUMBER}_README.md
          git commit -m "chore: Initialize branch for issue #$ISSUE_NUMBER

          This commit creates a branch for automated resolution of:
          ${{ steps.get_issue.outputs.issue_title }}
          
          Related Issue: #$ISSUE_NUMBER
          Author: @${{ steps.get_issue.outputs.issue_author }}"
          
          git push origin "$BRANCH_NAME"
          
          echo "branch_created=true" >> $GITHUB_OUTPUT
      
      - name: Create draft PR with Copilot assignment
        id: create_pr
        if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true' && steps.create_branch.outputs.branch_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          BRANCH_NAME="${{ steps.generate_details.outputs.branch_name }}"
          PR_TITLE="${{ steps.generate_details.outputs.pr_title }}"
          
          # Create PR body with Copilot mention
          cat > /tmp/pr_body.md << 'PR_BODY_EOF'
          ## ðŸ¤– Automated Draft PR for Issue #${{ steps.get_issue.outputs.issue_number }}
          
          This draft PR was automatically created to address the following issue:
          
          **Issue**: #${{ steps.get_issue.outputs.issue_number }} - ${{ steps.get_issue.outputs.issue_title }}
          **Author**: @${{ steps.get_issue.outputs.issue_author }}
          
          ### Issue Description
          
          PR_BODY_EOF
          
          cat /tmp/issue_body.txt >> /tmp/pr_body.md
          
          cat >> /tmp/pr_body.md << 'PR_BODY_EOF'
          
          ### Implementation Request
          
          @copilot please analyze this issue and implement the necessary changes to resolve it.
          
          Focus on:
          1. Understanding the issue requirements
          2. Making minimal, focused changes
          3. Ensuring tests pass
          4. Following project conventions
          
          ### Related
          
          Fixes #${{ steps.get_issue.outputs.issue_number }}
          
          ---
          
          ðŸ¤– *This PR was auto-generated by the Issue-to-Draft-PR workflow*
          PR_BODY_EOF
          
          # Create the draft PR
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/pr_body.md \
            --draft \
            --head "$BRANCH_NAME" \
            --repo ${{ github.repository }})
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "## âœ… Draft PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **PR URL**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub Copilot has been mentioned in the PR and will automatically implement the fix." >> $GITHUB_STEP_SUMMARY
      
      - name: Link PR to issue
        if: steps.create_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.get_issue.outputs.issue_number }}"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"
          
          # Comment on the issue with PR link
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– Draft PR #$PR_NUMBER has been automatically created to address this issue.

          GitHub Copilot will analyze the issue and implement the necessary changes.
          
          [View Draft PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)"
          
          echo "## ðŸ”— Issue Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comment added to issue #$ISSUE_NUMBER linking to draft PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
